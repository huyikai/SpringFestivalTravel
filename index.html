<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 æ˜¥èŠ‚åŒ—äº¬Â·å´‡ç¤¼å†°é›ªä¹‹æ—…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Default fallback values */
            --nav-height: 54px; 
            --scroll-offset: 115px; /* Matches the visual sticky height */
        }

        body { font-family: 'Noto Sans SC', sans-serif; background-color: #fdfbf7; color: #333; }
        .chart-container { position: relative; width: 100%; max-width: 600px; margin: 0 auto; height: 300px; max-height: 400px; }
        .timeline-line { position: absolute; left: 1.25rem; top: 1rem; bottom: 0; width: 2px; background-color: #e5e7eb; z-index: 0; }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .card-shadow { box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); }
        /* CHANGED: Increased font-weight from 600 to 700 (bold) for active tab */
        .active-tab { border-bottom: 2px solid #ef4444; color: #ef4444; font-weight: 700; }
        .inactive-tab { color: #6b7280; }
        .metro-step::after { content: ''; position: absolute; left: 50%; bottom: -1rem; transform: translateX(-50%); width: 2px; height: 1rem; background-color: #9ca3af; }
        .metro-step:last-child::after { display: none; }
        
        /* Global Smooth Scroll on the scroll container */
        #app-wrapper { scroll-behavior: smooth; }
        
        /* FIX: Use CSS variable for scroll margin to be perfectly dynamic */
        .day-anchor { scroll-margin-top: var(--scroll-offset); }
        
        /* FIX: Date nav sticky top position uses CSS variable */
        .date-nav-sticky-style {
            top: var(--nav-height);
        }
    </style>
    <!-- Chosen Palette: Warm Neutrals (Background) + Festival Red (Accents) + Slate (Text) -->
    <!-- Application Structure Plan: 
         1. Dashboard: Overview stats.
         2. Itinerary: UPDATED.
            FIXED: "Click vs Scroll" Conflict.
            Added a robust "isScrollingByClick" lock to prevent Scroll Spy from interfering during click navigation.
         3. Packing: Checklist. Updated to remove Driver's License.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
</head>
<body class="flex flex-col min-h-screen bg-gray-100">

    <!-- Mobile-First Layout Container -->
    <div id="app-wrapper" class="w-full max-w-md mx-auto bg-white shadow-xl h-screen flex flex-col relative overflow-y-auto hide-scrollbar">
        
        <!-- Header (Scrolls away) -->
        <!-- CHANGED: Made gradient slightly deeper (red-100/orange-100) per request -->
        <header class="bg-gradient-to-r from-red-100 to-orange-100 p-6 pt-10 shadow-sm z-10 shrink-0">
            <div class="flex justify-between items-start">
                <div>
                    <h2 class="text-sm font-bold text-red-500 tracking-widest uppercase mb-1">2026 æ˜¥èŠ‚è·¯ä¹¦</h2>
                    <h1 class="text-2xl font-bold text-gray-800">åŒ—äº¬Â·å´‡ç¤¼æ»‘é›ªä¹‹æ—…</h1>
                    <p class="text-gray-500 text-sm mt-1">ä¹‰å‡¯ & æ–‡ç£Š | 2æœˆ19æ—¥ - 22æ—¥</p>
                </div>
                <div class="bg-white p-2 rounded-xl shadow-sm text-center min-w-[60px]">
                    <span class="block text-xs text-gray-400">å¤©æ•°</span>
                    <span class="block text-xl font-bold text-gray-800">4</span>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs (App Level) -->
        <nav id="main-nav" class="sticky top-0 z-40 flex justify-around items-center bg-white border-b border-gray-100 shrink-0 shadow-sm transition-all">
            <button onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-4 text-sm font-medium transition-colors active-tab">æ¦‚è§ˆ</button>
            <button onclick="switchTab('itinerary')" id="tab-itinerary" class="flex-1 py-4 text-sm font-medium transition-colors inactive-tab">è¡Œç¨‹</button>
            <button onclick="switchTab('packing')" id="tab-packing" class="flex-1 py-4 text-sm font-medium transition-colors inactive-tab">æ¸…å•</button>
        </nav>
        
        <!-- Sticky Sub-Nav Container -->
        <div id="sub-nav-container" class="sticky z-30 bg-[#fdfbf7] py-2 px-4 shadow-sm transition-all hidden date-nav-sticky-style border-b border-gray-100">
            <!-- Date buttons will be injected here -->
        </div>

        <!-- Main Content Area -->
        <!-- CHANGED: Removed min-h-screen and reduced pb-24 to pb-8 to fix footer position issue -->
        <main id="app-content" class="flex-grow p-4 pb-8 bg-[#fdfbf7]">
            <!-- Dynamic Content Injected Here -->
        </main>

        <!-- Footer -->
        <footer class="p-4 text-center text-xs text-gray-300 bg-gray-50 border-t border-gray-100 shrink-0">
            Design for Mobile View â€¢ Spring Festival 2026
        </footer>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- Data Store ---
        const tripData = {
            overview: {
                stats: { travel: 10, activity: 22, rest: 35, food: 8 }
            },
            days: [
                {
                    id: 1,
                    date: "2æœˆ19æ—¥ åˆä¸‰",
                    title: "æŠµäº¬ & å¨æ–¯æ±€åº¦å‡",
                    highlight: "é«˜é“å‰å¾€åŒ—äº¬ï¼Œå…¥ä½ä¸œä¸‰ç¯ï¼Œäº«å—è€åŒ—äº¬é“œé”…æ¶®è‚‰ã€‚",
                    events: [
                        { time: "13:18", type: "transport", title: "é«˜é“ G72", detail: "é’å²›åŒ— -> åŒ—äº¬å—", sub: "02è½¦ 14D/14F (3å°æ—¶3åˆ†)" },
                        { 
                            time: "16:30", 
                            type: "metro", 
                            title: "å‰å¾€å¨æ–¯æ±€é…’åº—", 
                            detail: "åŒ—äº¬å—ç«™ -> å¨æ–¯æ±€é…’åº—", 
                            duration: "çº¦50åˆ†é’Ÿ",
                            route: [
                                { line: "14å·çº¿", from: "åŒ—äº¬å—ç«™", to: "åé‡Œæ²³ç«™", stops: "5ç«™" },
                                { line: "10å·çº¿", from: "åé‡Œæ²³ç«™", to: "äº®é©¬æ¡¥ç«™", stops: "9ç«™" },
                                { line: "æ­¥è¡Œ", info: "Cå£å‡ºç«™å³è¾¾" }
                            ]
                        },
                        { time: "17:30", type: "hotel", title: "åŠç†å…¥ä½", detail: "åŒ—äº¬å¨æ–¯æ±€é…’åº— (ç‡•è)", sub: "ç¡®è®¤æ—©é¤ & æ³³æ± " },
                        { 
                            time: "19:00", 
                            type: "food", 
                            title: "æ™šé¤ï¼šå—é—¨æ¶®è‚‰", 
                            detail: "æœé˜³å…¬å›­åº— / è€å¼é“œé”…æ¶®è‚‰", 
                            sub: "æˆ–è€…å»å›¢ç»“æ¹–åƒåšå‘³å±…ç‚™å­çƒ¤è‚‰ã€‚æ¨èæ‰“è½¦å‰å¾€ï¼ˆ10-15åˆ†é’Ÿï¼‰ã€‚" 
                        }
                    ]
                },
                {
                    id: 2,
                    date: "2æœˆ20æ—¥ åˆå››",
                    title: "æ³¡æ³¡ç›ç‰¹ & å¥”èµ´é›ªåœº",
                    highlight: "æ‰“å¡Pop Landï¼Œå…¨èšå¾·å¤–å–ç­–ç•¥ï¼Œé«˜é“å‰å¾€å´‡ç¤¼ã€‚",
                    events: [
                        { time: "09:30", type: "hotel", title: "é€€æˆ¿ & å¯„å­˜", detail: "è¡Œæå¯„å­˜åœ¨é…’åº—ç¤¼å®¾éƒ¨", sub: "è½»è£…å‡ºå‘å»ä¹å›­" },
                        { 
                            time: "10:00", 
                            type: "activity", 
                            title: "æ³¡æ³¡ç›ç‰¹åŸå¸‚ä¹å›­", 
                            detail: "æœé˜³å…¬å›­è¥¿3é—¨", 
                            sub: "å¿…ç©ï¼šMOLLYåŸå ¡å¿ƒæ„¿ä¹‹æ—…ã€‚å¿…é€›ï¼šåŸå ¡å•†åº—ä¹°é™å®šç›²ç›’ã€‚" 
                        },
                        { 
                            time: "13:30", 
                            type: "food", 
                            title: "ç‚¹å…¨èšå¾·å¤–å–", 
                            detail: "å®šç‚¹æŠ•å–‚ï¼šå¨æ–¯æ±€ç¤¼å®¾éƒ¨", 
                            sub: "æœ'ä¸‰å…ƒæ¡¥åº—'æˆ–'å›¢ç»“æ¹–åº—'ï¼Œå¤‡æ³¨14:30é€è¾¾ã€‚é¿å…æ’é˜Ÿç¥å™¨ï¼" 
                        },
                        { time: "14:30", type: "hotel", title: "å–è¡Œæ & å¤–å–", detail: "å›åˆ°é…’åº—æ‹¿è£…å¤‡å’Œçƒ¤é¸­" },
                        { 
                            time: "15:10", 
                            type: "metro", 
                            title: "æé™è½¬åœºï¼šå»æ¸…æ²³ç«™", 
                            detail: "å¨æ–¯æ±€ -> æ¸…æ²³ç«™", 
                            duration: "çº¦51åˆ†é’Ÿ (çº¢çº¿æ—¶é—´!)",
                            route: [
                                { line: "10å·çº¿", from: "äº®é©¬æ¡¥", to: "è¥¿åœŸåŸ", stops: "9ç«™" },
                                { line: "æ˜Œå¹³çº¿", from: "è¥¿åœŸåŸ", to: "æ¸…æ²³ç«™", stops: "6ç«™" }
                            ]
                        },
                        { time: "16:39", type: "transport", title: "é«˜é“ D9277", detail: "æ¸…æ²³ -> å¤ªå­åŸ", sub: "08è½¦ 04DFã€‚è½¦ä¸Šåƒçƒ¤é¸­ğŸ¦†" },
                        { time: "18:00", type: "hotel", title: "å…¥ä½å¤ªèˆå—å±±é‡Œ", detail: "å´‡ç¤¼å¤ªèˆæ»‘é›ªå°é•‡", sub: "åå…è´¹æ¥é©³è½¦è¿›å°é•‡ã€‚ç¡®è®¤å«æ—©/é›ªç¥¨ã€‚" }
                    ]
                },
                {
                    id: 3,
                    date: "2æœˆ21æ—¥ åˆäº”",
                    title: "å…¨å¤©æ»‘é›ª & å›äº¬",
                    highlight: "å¤ªèˆç•…æ»‘ä¸€å¤©ï¼Œæ™šä¸Šå›äº¬å…¥ä½å—é”£é¼“å··ï¼Œæ„Ÿå—èƒ¡åŒå¤œç”Ÿæ´»ã€‚",
                    events: [
                        { time: "09:00", type: "activity", title: "å¤ªèˆæ»‘é›ªæ—¶å…‰", detail: "å…¨å¤©æ»‘é›ª", sub: "ç§Ÿé›ªå…· -> æ¢è£…å¤‡ -> å¼€æ»‘ï¼åˆé¤ä¸åƒï¼Œä¸“å¿ƒæ»‘é›ªã€‚" },
                        { time: "16:30", type: "transport", title: "å‰å¾€ç«è½¦ç«™", detail: "åæ¥é©³è½¦å»å¤ªå­åŸç«™", sub: "é¢„ç•™å……è¶³æ—¶é—´é€€æˆ¿/è¿˜é›ªå…·" },
                        { time: "18:10", type: "transport", title: "é«˜é“ D9278", detail: "å¤ªå­åŸ -> æ¸…æ²³", sub: "08è½¦ 05DF" },
                        { 
                            time: "19:10", 
                            type: "metro", 
                            title: "å‰å¾€å…¨å­£é…’åº—", 
                            detail: "æ¸…æ²³ -> å®‰å®šé—¨", 
                            duration: "çº¦45åˆ†é’Ÿ",
                            route: [
                                { line: "13å·çº¿", from: "æ¸…æ²³", to: "è¥¿ç›´é—¨", stops: "5ç«™" },
                                { line: "2å·çº¿", from: "è¥¿ç›´é—¨", to: "å®‰å®šé—¨", stops: "3ç«™" },
                                { line: "æ­¥è¡Œ", info: "Aå£(è¥¿åŒ—å£)å‡ºï¼Œå‘å—400ç±³" }
                            ]
                        },
                        { time: "20:30", type: "hotel", title: "å…¥ä½å…¨å­£", detail: "å—é”£é¼“å··å®‰å®šé—¨åœ°é“ç«™åº—", sub: "å®µå¤œï¼šå—é”£é™„è¿‘å°åƒ" }
                    ]
                },
                {
                    id: 4,
                    date: "2æœˆ22æ—¥ åˆå…­",
                    title: "äº¬å‘³Citywalk & è¿”ç¨‹",
                    highlight: "åœ°é“è±†æ±å„¿ç„¦åœˆï¼Œæ¼«æ­¥ä»€åˆ¹æµ·èƒ¡åŒï¼Œæ‰“å¡ä¸­è½´çº¿ã€‚",
                    events: [
                        { time: "08:00", type: "food", title: "ç¢³æ°´çˆ†ç‚¸æ—©é¤", detail: "å¢ç››é­å°åƒ or å§šè®°ç‚’è‚", sub: "é€€æˆ¿å¯„å­˜è¡Œæåœ¨é…’åº—ã€‚æ¨èç³–æ²¹é¥¼ã€è±†è…è„‘ã€‚" },
                        { time: "09:30", type: "activity", title: "èƒ¡åŒCitywalk", detail: "ä»€åˆ¹æµ·å‘¨è¾¹", sub: "é¼“æ¥¼ -> çƒŸè¢‹æ–œè¡— -> é“¶é”­æ¡¥ -> å®‹åº†é¾„æ•…å±…" },
                        { 
                            time: "12:00", 
                            type: "activity", 
                            title: "åŒ—ä¸­è½´çº¿æ¼«æ­¥", 
                            detail: "é›å’Œå®« / å›½å­ç›‘", 
                            sub: "äº”é“è¥èƒ¡åŒå–å’–å•¡ã€‚é¿å…æŠ˜è¿”è·‘ï¼Œä¸æ¨èå»å›½åšï¼ˆå¤ªè¿œ+éš¾çº¦ï¼‰ã€‚" 
                        },
                        { time: "17:00", type: "hotel", title: "å›é…’åº—å–è¡Œæ", detail: "å›åˆ°å…¨å­£å–è¡Œæ", sub: "å¿…é¡»å‡†æ—¶ï¼" },
                        { 
                            time: "17:30", 
                            type: "metro", 
                            title: "å‰å¾€åŒ—äº¬å—ç«™", 
                            detail: "å®‰å®šé—¨ -> åŒ—äº¬å—ç«™", 
                            duration: "çº¦47åˆ†é’Ÿ",
                            route: [
                                { line: "2å·çº¿", from: "å®‰å®šé—¨", to: "å®£æ­¦é—¨", stops: "8ç«™" },
                                { line: "4å·çº¿", from: "å®£æ­¦é—¨", to: "åŒ—äº¬å—ç«™", stops: "3ç«™" }
                            ]
                        },
                        { time: "19:36", type: "transport", title: "é«˜é“ G891", detail: "åŒ—äº¬å— -> é’å²›åŒ—", sub: "å›å®¶å•¦ï¼ğŸ‘‹" }
                    ]
                }
            ],
            packing: [
                { cat: "è¯ä»¶", items: ["èº«ä»½è¯ (å¿…é¡»å¸¦!)"] },
                { cat: "æ»‘é›ªè£…å¤‡", items: ["é€Ÿå¹²è¡£/è£¤", "æ»‘é›ªè¢œ", "é˜²æ°´æ‰‹å¥—", "æŠ¤è„¸/é¢ç½©", "é›ªé•œ", "å¤´ç›”", "å†…æŠ¤"] },
                { cat: "è¡£ç‰©", items: ["æ³³è¡£/æ³³å¸½ (å¨æ–¯æ±€)", "æ¢æ´—å†…è¡£è£¤", "ä¿æš–å¤–å¥—", "èˆ’é€‚èµ°è·¯é‹"] },
                { cat: "ç”µå­", items: ["å……ç”µå® (ä¹å›­/ä½æ¸©è´¹ç”µ)", "å……ç”µå™¨", "è€³æœº","osmo pocket"] },
                { cat: "ä¸ªæŠ¤", items: ["é«˜ä¿æ¹¿é¢éœœ (åŒ—äº¬æå¹²)", "æ¶¦å”‡è†", "é˜²æ™’éœœ (é›ªåœºç´«å¤–çº¿å¼º)", "é¢è†œ"] }
            ]
        };

        // --- State Management ---
        let currentTab = 'dashboard';
        let isScrollingByClick = false; // LOCK Flag
        let scrollTimeout = null;
        let itineraryScrollListener = null;

        // --- Helper: Update Dynamic Heights ---
        function updateLayoutMetrics() {
            const nav = document.getElementById('main-nav');
            const subNav = document.getElementById('sub-nav-container');
            if (nav) {
                const navHeight = nav.offsetHeight;
                document.documentElement.style.setProperty('--nav-height', `${navHeight}px`);
                
                let subNavHeight = 60; // default estimate
                if (subNav && !subNav.classList.contains('hidden')) {
                    subNavHeight = subNav.offsetHeight;
                }
                // Calculate total offset for scroll-margin-top
                const totalOffset = navHeight + subNavHeight + 10; 
                document.documentElement.style.setProperty('--scroll-offset', `${totalOffset}px`);
            }
        }

        // --- Helper: Highlight Active Button ---
        function highlightActiveButton(activeId) {
            document.querySelectorAll('[id^="btn-day-"]').forEach(b => {
                b.className = `flex-shrink-0 px-6 py-2 rounded-full text-sm font-bold transition-all bg-white text-gray-600 border border-gray-200 shadow-sm hover:text-red-500 hover:border-red-300 active:scale-95`;
            });
            const activeBtn = document.getElementById(`btn-day-${activeId}`);
            if (activeBtn) {
                activeBtn.className = `flex-shrink-0 px-6 py-2 rounded-full text-sm font-bold transition-all bg-red-500 text-white border-red-500 shadow-md transform scale-105`;
                // Ensure the active button is visible in horizontal scroll
                activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
        }

        // --- Render Functions ---

        function switchTab(tab) {
            currentTab = tab;
            const subNav = document.getElementById('sub-nav-container');
            const wrapper = document.getElementById('app-wrapper');

            // Cleanup old listener
            if (itineraryScrollListener) {
                wrapper.removeEventListener('scroll', itineraryScrollListener);
                itineraryScrollListener = null;
            }

            // Update Tab UI
            ['dashboard', 'itinerary', 'packing'].forEach(t => {
                const btn = document.getElementById(`tab-${t}`);
                if (t === tab) {
                    btn.classList.remove('inactive-tab');
                    btn.classList.add('active-tab');
                } else {
                    btn.classList.add('inactive-tab');
                    btn.classList.remove('active-tab');
                }
            });

            // Toggle Sub Nav
            if (tab === 'itinerary') {
                subNav.classList.remove('hidden');
            } else {
                subNav.classList.add('hidden');
            }

            if (wrapper) wrapper.scrollTop = 0;
            
            renderContent();
            setTimeout(updateLayoutMetrics, 50);
        }

        function renderContent() {
            const container = document.getElementById('app-content');
            container.innerHTML = '';

            if (currentTab === 'dashboard') {
                renderDashboard(container);
            } else if (currentTab === 'itinerary') {
                renderItinerary(container);
            } else if (currentTab === 'packing') {
                renderPackingList(container);
            }
        }

        function renderDashboard(container) {
            const intro = document.createElement('div');
            intro.className = 'mb-6';
            intro.innerHTML = `
                <div class="bg-gradient-to-r from-red-500 to-orange-400 rounded-2xl p-6 text-white shadow-lg mb-6">
                    <h3 class="font-bold text-lg mb-2">ğŸ‰ è·ç¦»å‡ºå‘è¿˜æœ‰...</h3>
                    <p class="text-sm opacity-90 mb-4">å‡†å¤‡å¥½è¿æ¥æ»‘é›ªå’Œçƒ¤é¸­äº†å—ï¼Ÿ</p>
                    <div class="flex gap-4 text-center">
                        <div class="bg-white/20 rounded-lg p-2 flex-1 backdrop-blur-sm">
                            <span class="block text-2xl font-bold">19</span>
                            <span class="text-xs opacity-80">2æœˆ</span>
                        </div>
                        <div class="bg-white/20 rounded-lg p-2 flex-1 backdrop-blur-sm">
                            <span class="block text-2xl font-bold">åŒ—äº¬</span>
                            <span class="text-xs opacity-80">ç›®çš„åœ°</span>
                        </div>
                        <div class="bg-white/20 rounded-lg p-2 flex-1 backdrop-blur-sm">
                            <span class="block text-2xl font-bold">å´‡ç¤¼</span>
                            <span class="text-xs opacity-80">æ»‘é›ª</span>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(intro);

            const chartSection = document.createElement('div');
            chartSection.className = 'bg-white rounded-2xl p-6 card-shadow mb-6';
            chartSection.innerHTML = `
                <h3 class="font-bold text-gray-800 mb-4 flex items-center">
                    <span class="mr-2 text-xl">ğŸ“Š</span> è¡Œç¨‹æ—¶é—´åˆ†é…
                </h3>
                <p class="text-xs text-gray-500 mb-4">é€šè¿‡åˆ†æ4å¤©è¡Œç¨‹ï¼Œçœ‹çœ‹æˆ‘ä»¬çš„æ—¶é—´èŠ±åœ¨å“ªå„¿äº†ã€‚</p>
                <div class="chart-container">
                    <canvas id="tripChart"></canvas>
                </div>
            `;
            container.appendChild(chartSection);

            const reminders = document.createElement('div');
            reminders.className = 'bg-yellow-50 border border-yellow-100 rounded-2xl p-6';
            reminders.innerHTML = `
                <h3 class="font-bold text-yellow-800 mb-3 flex items-center">âš ï¸ é‡è¦æé†’</h3>
                <ul class="space-y-2 text-sm text-yellow-700">
                    <li class="flex items-start"><span class="mr-2">ğŸ”¹</span>å›½åšéœ€æå‰7å¤©é¢„çº¦ (æ¯æ—¥17:00æ”¾ç¥¨)</li>
                    <li class="flex items-start"><span class="mr-2">ğŸ”¹</span>åˆå››è®°å¾—ç‚¹å…¨èšå¾·å¤–å–é€åˆ°å¨æ–¯æ±€</li>
                    <li class="flex items-start"><span class="mr-2">ğŸ”¹</span>è®°å¾—å¸¦æ³³è¡£ (å¨æ–¯æ±€) å’Œé«˜ä¿æ¹¿éœœ</li>
                </ul>
            `;
            container.appendChild(reminders);

            setTimeout(() => {
                const chartCanvas = document.getElementById('tripChart');
                if (chartCanvas && typeof Chart !== 'undefined') {
                    const ctx = chartCanvas.getContext('2d');
                    new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['è·¯é€”äº¤é€š', 'æ¸¸ç©/æ»‘é›ª', 'ç¡çœ /ä¼‘æ¯', 'ç¾é£Ÿæ¢ç´¢'],
                            datasets: [{
                                data: [tripData.overview.stats.travel, tripData.overview.stats.activity, tripData.overview.stats.rest, tripData.overview.stats.food],
                                backgroundColor: ['#94a3b8', '#f87171', '#e2e8f0', '#fbbf24'],
                                borderWidth: 0
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { usePointStyle: true, boxWidth: 8 } } } }
                    });
                }
            }, 0);
        }

        function renderItinerary(container) {
            // 1. POPULATE STICKY SUB-NAV
            const subNav = document.getElementById('sub-nav-container');
            subNav.innerHTML = ''; 

            const dayNav = document.createElement('div');
            dayNav.className = 'flex gap-3 overflow-x-auto hide-scrollbar px-3';

            tripData.days.forEach(day => {
                const btn = document.createElement('button');
                btn.id = `btn-day-${day.id}`;
                btn.className = `flex-shrink-0 px-6 py-2 rounded-full text-sm font-bold transition-all bg-white text-gray-600 border border-gray-200 shadow-sm hover:text-red-500 hover:border-red-300 active:scale-95`;
                btn.innerText = day.date.split(' ')[0];

                // CLICK HANDLER WITH LOCK
                btn.onclick = (e) => { 
                    isScrollingByClick = true; // LOCK scroll spy
                    
                    const el = document.getElementById(`day-section-${day.id}`);
                    if(el) {
                        // Immediately highlight clicked button
                        highlightActiveButton(day.id);
                        
                        // Scroll to element
                        el.scrollIntoView({ behavior: 'smooth', block: 'start' });

                        // Release lock after animation finishes (approx 800-1000ms)
                        if(scrollTimeout) clearTimeout(scrollTimeout);
                        scrollTimeout = setTimeout(() => {
                            isScrollingByClick = false;
                        }, 1000); 
                    }
                };
                dayNav.appendChild(btn);
            });
            subNav.appendChild(dayNav);

            // 2. RENDER CONTENT
            const listContainer = document.createElement('div');
            listContainer.className = 'pb-10 pt-2';

            tripData.days.forEach((day, index) => {
                const daySection = document.createElement('div');
                daySection.id = `day-section-${day.id}`;
                daySection.className = 'mb-12 relative day-anchor'; 

                const header = document.createElement('div');
                header.className = 'mb-6 px-2 flex items-center';
                header.innerHTML = `
                    <div class="w-10 h-10 rounded-xl bg-red-500 text-white flex items-center justify-center font-bold text-lg shadow-md shrink-0">${day.id}</div>
                    <div class="ml-4"><h2 class="text-xl font-bold text-gray-800">${day.date}</h2><p class="text-xs text-gray-500 mt-0.5">${day.title}</p></div>
                `;
                daySection.appendChild(header);

                const timelineContainer = document.createElement('div');
                timelineContainer.className = 'relative pl-4';
                const line = document.createElement('div');
                line.className = 'timeline-line'; 
                timelineContainer.appendChild(line);

                day.events.forEach(event => {
                    const item = document.createElement('div');
                    item.className = 'relative mb-8 pl-8';
                    
                    let icon = 'ğŸ“';
                    let iconBg = 'bg-gray-100';
                    if (event.type === 'transport') { icon = 'ğŸš„'; iconBg = 'bg-blue-100'; }
                    if (event.type === 'metro') { icon = 'ğŸš‡'; iconBg = 'bg-indigo-100'; }
                    if (event.type === 'hotel') { icon = 'ğŸ¨'; iconBg = 'bg-purple-100'; }
                    if (event.type === 'food') { icon = 'ğŸœ'; iconBg = 'bg-yellow-100'; }
                    if (event.type === 'activity') { icon = 'ğŸ¡'; iconBg = 'bg-red-100'; }

                    let extraContent = '';
                    if (event.route) {
                        const stepsHtml = event.route.map(step => {
                            if (step.line === 'æ­¥è¡Œ') return `<div class="flex items-center text-xs text-gray-500 mt-2"><span class="mr-2">ğŸš¶</span> ${step.info}</div>`;
                            return `<div class="relative pl-6 pb-4 border-l-2 border-gray-300 last:border-0 last:pb-0 metro-step"><div class="absolute -left-[5px] top-1 w-2 h-2 rounded-full bg-gray-400"></div><div class="font-bold text-gray-700 text-sm">${step.line}</div><div class="flex justify-between text-xs text-gray-500"><span>${step.from} â†’ ${step.to}</span><span class="bg-gray-100 px-1 rounded">${step.stops || ''}</span></div></div>`;
                        }).join('');
                        extraContent = `<div class="mt-3 bg-gray-50 rounded-lg p-3 border border-gray-200"><div class="text-xs font-bold text-gray-400 uppercase mb-2 tracking-wider">è·¯çº¿è¯¦æƒ…</div>${stepsHtml}</div>`;
                    }

                    item.innerHTML = `
                        <div class="absolute left-0 top-0 w-10 h-10 rounded-full ${iconBg} flex items-center justify-center border-4 border-white z-10 shadow-sm text-lg">${icon}</div>
                        <div class="bg-white p-4 rounded-xl card-shadow">
                            <div class="flex justify-between items-start mb-1"><h4 class="font-bold text-gray-800 text-base">${event.title}</h4><span class="text-xs font-bold text-red-500 bg-red-50 px-2 py-1 rounded-full">${event.time}</span></div>
                            <p class="text-sm text-gray-600 font-medium">${event.detail}</p>
                            ${event.duration ? `<p class="text-xs text-blue-500 mt-1 flex items-center">â±ï¸ ${event.duration}</p>` : ''}
                            ${event.sub ? `<p class="text-xs text-gray-400 mt-2 pt-2 border-t border-gray-50">${event.sub}</p>` : ''}
                            ${extraContent}
                        </div>
                    `;
                    timelineContainer.appendChild(item);
                });

                daySection.appendChild(timelineContainer);
                listContainer.appendChild(daySection);
            });

            container.appendChild(listContainer);

            // 3. SCROLL SPY LISTENER
            const wrapper = document.getElementById('app-wrapper');
            
            itineraryScrollListener = () => {
                if (isScrollingByClick) return; // SKIP if locked

                // Threshold: Sticky header height (~115px) + buffer
                const headerOffset = 130; 
                let activeId = null;

                for (let i = 0; i < tripData.days.length; i++) {
                    const day = tripData.days[i];
                    const el = document.getElementById(`day-section-${day.id}`);
                    if (el) {
                        const rect = el.getBoundingClientRect();
                        // Logic: Find the LAST element whose TOP is above or near the threshold line
                        if (rect.top <= headerOffset + 50) {
                            activeId = day.id;
                        }
                    }
                }

                if (activeId) {
                    highlightActiveButton(activeId);
                }
            };

            wrapper.addEventListener('scroll', itineraryScrollListener);
            // Initial highlight
            highlightActiveButton(1);
        }

        function renderPackingList(container) {
            const intro = document.createElement('p');
            intro.className = 'text-sm text-gray-500 mb-6';
            intro.innerText = 'å‡ºå‘å‰æ£€æŸ¥ä¸€éï¼Œç¡®ä¿ä¸‡æ— ä¸€å¤±ã€‚ç‚¹å‡»å‹¾é€‰ âœ…';
            container.appendChild(intro);

            tripData.packing.forEach(category => {
                const section = document.createElement('div');
                section.className = 'mb-6 bg-white rounded-xl p-4 card-shadow';
                section.innerHTML = `<h3 class="font-bold text-gray-800 mb-3 flex items-center"><span class="w-2 h-6 bg-red-500 rounded-full mr-3"></span>${category.cat}</h3>`;
                const list = document.createElement('ul');
                category.items.forEach((item, idx) => {
                    const li = document.createElement('li');
                    li.className = 'flex items-center py-2 border-b border-gray-50 last:border-0';
                    const id = `item-${category.cat}-${idx}`;
                    li.innerHTML = `<input type="checkbox" id="${id}" class="w-5 h-5 rounded border-gray-300 text-red-500 focus:ring-red-500 mr-3 cursor-pointer"><label for="${id}" class="text-sm text-gray-600 cursor-pointer select-none flex-1">${item}</label>`;
                    list.appendChild(li);
                });
                section.appendChild(list);
                container.appendChild(section);
            });
        }

        window.onload = function() {
            renderContent();
            updateLayoutMetrics();
            window.addEventListener('resize', updateLayoutMetrics);
        };
    </script>
</body>
</html>
